name: Create Debian Package

on:
  push:
    branches:
      - master

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Prepare Debian package directory
        run: |
          mkdir -p turingmachine.pro/debian
          echo "Source: turingmachine.pro" >> turingmachine.pro/debian/control
          echo "Section: devel" >> turingmachine.pro/debian/control
          echo "Priority: optional" >> turingmachine.pro/debian/control
          echo "Maintainer: Pavlos Orfanidis <pavlos@orfanidis.net.gr>" >> turingmachine.pro/debian/control
          echo "Build-Depends: debhelper (>= 11), python3-all, other-build-dependencies" >> turingmachine.pro/debian/control
          echo "Standards-Version: 4.5.1" >> turingmachine.pro/debian/control
          echo "" >> turingmachine.pro/debian/control
          echo "Package: turingmachine.pro" >> turingmachine.pro/debian/control
          echo "Architecture: all" >> turingmachine.pro/debian/control
          echo "Depends: python3-pip, python3-venv, ${shlibs:Depends}, ${misc:Depends}" >> turingmachine.pro/debian/control
          echo "Description: Run any Turing machine possible using this app" >> turingmachine.pro/debian/control
          echo " Long description goes here if needed." >> turingmachine.pro/debian/control
          echo "Postinst: debian/postinst" >> turingmachine.pro/debian/control


          cp changelog turingmachine.pro/debian/
          cp rules turingmachine.pro/debian/
          chmod +x turingmachine.pro/debian/rules
          cp postinst turingmachine.pro/debian
          chmod +x turingmachine.pro/debian/postinst

          mkdir -p turingmachine.pro/usr/bin/turingmachine.pro
          chmod +w turingmachine.pro/usr/bin/turingmachine.pro
          cp turingmachine.pro.py turingmachine.pro/usr/bin/turingmachine.pro
          cp ui_form.py turingmachine.pro/usr/bin/turingmachine.pro
          cp requirements.txt turingmachine.pro/usr/bin/turingmachine.pro
          cp ui_license_import.py turingmachine.pro/usr/bin/turingmachine.pro
          chmod +x turingmachine.pro/usr/bin/turingmachine.pro/turingmachine.pro.py

          mkdir -p turingmachine.pro/usr/share/applications
          echo "[Desktop Entry]" >> turingmachine.pro/usr/share/applications/turingmachine.pro.desktop
          echo "Name=TuringMachine.Pro" >> turingmachine.pro/usr/share/applications/turingmachine.pro.desktop
          echo "Exec=/usr/bin/turingmachine.pro/venv/bin/python3 /usr/bin/turingmachine.pro/turingmachine.pro.py" >> turingmachine.pro/usr/share/applications/turingmachine.pro.desktop
          echo "Icon=/usr/share/icons/turingmachine.pro.jpg" >> turingmachine.pro/usr/share/applications/turingmachine.pro.desktop
          echo "Type=Application" >> turingmachine.pro/usr/share/applications/turingmachine.pro.desktop

          mkdir -p turingmachine.pro/usr/share/icons
          cp turingmachine.pro.jpg turingmachine.pro/usr/share/icons
      
      - name: Install Build Dependencies
        run: sudo apt-get install -y devscripts

      - name: Create original tar file
        run: tar -czvf turingmachine.pro_1.0.0.orig.tar.gz turingmachine.pro


      - name: Build and Sign Debian Package
        run: |
          # Import the GPG private key
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
          export DEBFULLNAME="Pavlos Orfanidis"
          export DEBEMAIL="pavlos@orfanidis.net.gr"

          cd turingmachine.pro

          # Build and sign the source package
          debuild -S -k666855A91B3897F4

          # Sign the .changes file
          echo "${{ secrets.GPG_PASSPHRASE }}" | debsign -k666855A91B3897F4 your-package_version_source.changes
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
      - name: List Files
        run: ls -la

#      - name: Upload DEB artifact
#        uses: actions/upload-artifact@v2
#        with:
#          name: turingmachine.pro.deb
#          path: turingmachine.pro.deb
